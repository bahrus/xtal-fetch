import{XtalFetchGet}from"./xtal-fetch-get.js";import{define}from"./node_modules/xtal-latx/define.js";import{baseLinkId,BaseLinkId}from"./node_modules/xtal-latx/base-link-id.js";export function snakeToCamel(s){return s.replace(/(\-\w)/g,function(m){return m[1].toUpperCase()})}var debounceDuration="debounce-duration",reqInitRequired="req-init-required",cacheResults="cache-results",insertResults="insert-results",req_init="req-init";export var XtalFetchReq=function(_BaseLinkId){babelHelpers.inherits(XtalFetchReq,_BaseLinkId);function XtalFetchReq(){var _this;babelHelpers.classCallCheck(this,XtalFetchReq);_this=babelHelpers.possibleConstructorReturn(this,(XtalFetchReq.__proto__||Object.getPrototypeOf(XtalFetchReq)).call(this));_this._cacheResults=!1;_this._cachedResults={};_this._fetchInProgress=!1;_this._reqInit=null;return _this}babelHelpers.createClass(XtalFetchReq,[{key:"onPropsChange",value:function onPropsChange(){if(this.reqInitRequired&&!this.reqInit)return;if(!this.__loadNewUrlDebouncer){this.debounceDurationHandler()}this.__loadNewUrlDebouncer()}},{key:"attributeChangedCallback",value:function attributeChangedCallback(name,oldValue,newValue){switch(name){case debounceDuration:this._debounceDuration=parseFloat(newValue);this.debounceDurationHandler();break;case reqInitRequired:case cacheResults:case insertResults:this["_"+snakeToCamel(name)]=null!==newValue;break;case baseLinkId:this._baseLinkId=newValue;break;case req_init:this._reqInit=JSON.parse(newValue);break;}babelHelpers.get(XtalFetchReq.prototype.__proto__||Object.getPrototypeOf(XtalFetchReq.prototype),"attributeChangedCallback",this).call(this,name,oldValue,newValue)}},{key:"debounce",value:function debounce(func,wait,immediate){var timeout;return function(){var context=this,args=arguments;clearTimeout(timeout);timeout=setTimeout(function(){timeout=null;if(!immediate)func.apply(context,args)},wait);if(immediate&&!timeout)func.apply(context,args)}}},{key:"debounceDurationHandler",value:function debounceDurationHandler(){var _this2=this;this.__loadNewUrlDebouncer=this.debounce(function(){_this2.loadNewUrl()},this._debounceDuration)}},{key:"do",value:function _do(){var _this3=this;this.errorResponse=null;if(this._cacheResults){var val=this.cachedResults[this._href];if(val){this.result=val;return}}this.fetchInProgress=!0;var href=this.href;href=this.getFullURL(href);if("undefined"!==typeof AbortController){this._controller=new AbortController;var sig=this._controller.signal;if(this._reqInit){this._reqInit.signal=sig}else{this._reqInit={signal:sig}}}self.fetch(href,this._reqInit).then(function(resp){_this3.fetchInProgress=!1;resp[_this3._as]().then(function(result){if(200!==resp.status){_this3.errorResponse=resp;var respText=resp.text;if(respText)respText().then(function(val){_this3.errorText=val})}else{_this3.result=result;if(_this3.cachedResults){_this3.cachedResults[_this3._href]=result}if("string"===typeof result&&_this3._insertResults){_this3.style.display=_this3._initDisp;_this3.innerHTML=result}var detail={href:_this3.href,result:result};_this3.de("fetch-complete",detail,!0)}})}).catch(function(err){if("AbortError"===err.name){console.log("Fetch aborted");_this3.fetchInProgress=!1}})}},{key:"connectedCallback",value:function connectedCallback(){this._upgradeProperties(["debounceDuration","reqInitRequired","cacheResults","reqInit"]);babelHelpers.get(XtalFetchReq.prototype.__proto__||Object.getPrototypeOf(XtalFetchReq.prototype),"connectedCallback",this).call(this)}},{key:"reqInit",get:function get(){return this._reqInit},set:function set(val){this._reqInit=val;this.onPropsChange()}},{key:"cacheResults",get:function get(){return this._cacheResults},set:function set(val){this.attr(cacheResults,val,"")}},{key:"cachedResults",get:function get(){return this._cachedResults}},{key:"reqInitRequired",get:function get(){return this.hasAttribute(reqInitRequired)},set:function set(val){this.attr(reqInitRequired,val,"")}},{key:"debounceDuration",get:function get(){return this._debounceDuration},set:function set(val){this.setAttribute(debounceDuration,val.toString())}},{key:"errorResponse",get:function get(){return this._errorResponse},set:function set(val){this._errorResponse=val;this.de("error-response",{value:val})}},{key:"errorText",get:function get(){return this._errorText},set:function set(val){this._errorText=val;this.de("error-text",{value:val})}},{key:"fetchInProgress",get:function get(){return this._fetchInProgress},set:function set(val){this._fetchInProgress=val;this.de("fetch-in-progress",{value:val})}},{key:"insertResults",get:function get(){return this._insertResults},set:function set(val){this.attr(insertResults,val,"")}},{key:"abort",set:function set(){if(this._controller)this._controller.abort()}}],[{key:"is",get:function get(){return"xtal-fetch-req"}},{key:"observedAttributes",get:function get(){return babelHelpers.get(XtalFetchReq.__proto__||Object.getPrototypeOf(XtalFetchReq),"observedAttributes",this).concat([debounceDuration,reqInitRequired,cacheResults,insertResults,baseLinkId,req_init])}}]);return XtalFetchReq}(BaseLinkId(XtalFetchGet));define(XtalFetchReq);